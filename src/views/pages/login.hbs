{{> header}}
<div class="auth-wrapper" style="max-width: 900px; margin: 2rem auto; padding: 1.5rem;">
  {{#if success}}
    <div class="alert alert-success">{{success}}</div>
  {{/if}}
  {{#if error}}
    <div class="alert alert-danger">{{error}}</div>
  {{/if}}

  <div class="tabs">
    <button id="tab-login"  class="tab active" type="button">Login</button>
    <button id="tab-register" class="tab" type="button">Register</button>
  </div>

  <div class="panels">
    {{!-- ===== LOGIN ===== --}}
    <section id="panel-login" class="panel active">
      <h2>Iniciar sesi√≥n</h2>
      <p class="muted">Pod√©s usar <strong>email</strong> o <strong>nombre</strong> en el campo ‚ÄúUsuario‚Äù.</p>

      <form method="POST" id="loginForm" autocomplete="on" novalidate>
        <div class="form-row">
          <label for="identifier">Usuario (email)</label>
          <input id="identifier" name="identifier" type="text" required placeholder="ej: example@example.com" />
        </div>

        <div class="form-row">
          <label for="password">Contrase√±a</label>
          <div class="password-field">
            <input id="password" name="password" type="password" required minlength="6" />
            <button type="button" class="toggle-pass" data-target="#password" aria-label="Mostrar/Ocultar contrase√±a">üëÅÔ∏è</button>
          </div>
        </div>

        <div class="extra-links">
          <a href="/users/forgot-password">¬øOlvidaste tu contrase√±a?</a>
      </div>
      
        {{#if redirectTo}}
          <input type="hidden" name="redirectTo" value="{{redirectTo}}" />
        {{/if}}

        <button class="btn primary" type="submit">Entrar</button>
      </form>
    </section>

    {{!-- ===== REGISTER ===== --}}
    <section id="panel-register" class="panel">
      <h2>Crear cuenta</h2>

      <form method="POST" action="/api/users/register" autocomplete="on" novalidate>
        <div class="grid-2">
          <div class="form-row">
            <label for="first_name">Nombre</label>
            <input id="first_name" name="first_name" type="text" required />
          </div>

          <div class="form-row">
            <label for="last_name">Apellido</label>
            <input id="last_name" name="last_name" type="text" required />
          </div>
        </div>

        <div class="form-row">
          <label for="email">Email</label>
          <input id="email" name="email" type="email" required />
        </div>

        <div class="form-row">
          <label for="age">Edad</label>
          <input id="age" name="age" type="number" min="0" step="1" required />
        </div>

        <div class="form-row">
          <label for="role">Rol</label>
          <select id="role" name="role" required>
            <option value="user" selected>user</option>
            <option value="admin">admin</option>
          </select>
        </div>

        <div class="grid-2">
          <div class="form-row">
            <label for="reg_password">Contrase√±a</label>
            <div class="password-field">
              <input id="reg_password" name="password" type="password" required minlength="6" />
              <button type="button" class="toggle-pass" data-target="#reg_password" aria-label="Mostrar/Ocultar contrase√±a">üëÅÔ∏è</button>
            </div>
          </div>

          <div class="form-row">
            <label for="confirm_password">Confirmar contrase√±a</label>
            <div class="password-field">
              <input id="confirm_password" name="confirm_password" type="password" required minlength="6" />
              <button type="button" class="toggle-pass" data-target="#confirm_password" aria-label="Mostrar/Ocultar contrase√±a">üëÅÔ∏è</button>
            </div>
          </div>
        </div>

        <button class="btn primary" type="submit">Registrarme</button>
      </form>
    </section>
  </div>
</div>
{{> footer}}

<style>
    select {
    padding: .6rem .7rem;
    border: 1px solid #ddd;
    border-radius: 8px;
    background: #fff;
    outline: none;
    font-size: .95rem;
    cursor: pointer;
  }

  select:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 3px rgba(13,110,253,.15);
  }

  .auth-wrapper {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 6px 24px rgba(0,0,0,.06);
  }
  .tabs {
    display: flex;
    gap: .5rem;
    margin-bottom: 1rem;
  }
  .tab {
    padding: .6rem 1rem;
    border-radius: 999px;
    border: 1px solid #ddd;
    background: #f7f7f7;
    cursor: pointer;
  }
  .tab.active {
    background: #0d6efd;
    color: #fff;
    border-color: #0d6efd;
  }
  .panels .panel {
    display: none;
  }
  .panels .panel.active {
    display: block;
  }
  .form-row {
    display: flex;
    flex-direction: column;
    gap: .4rem;
    margin-bottom: .9rem;
  }
  .grid-2 {
    display: grid;
    grid-template-columns: 1fr 1fr; gap: .9rem;
    }
  input[type="text"], input[type="email"], input[type="number"], input[type="password"] {
    padding: .6rem .7rem;
    border: 1px solid #ddd;
    border-radius: 8px; outline: none;
  }
  input:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 3px rgba(13,110,253,.15);
  }
  .btn.primary {
    padding: .7rem 1.1rem;
    border: none;
    border-radius: 8px;
    background: #0d6efd;
    color: #fff; cursor: pointer;
  }
  .btn.primary:hover {
    filter: brightness(1.05);
  }
  .muted {
    color: #666;
    font-size: .9rem;
    margin-bottom: .8rem;
  }
  .password-field {
    display: flex;
    gap: .4rem;
    align-items: stretch;
  }
  .password-field input {
    flex: 1;
  }
  .toggle-pass {
    padding: 0 .8rem;
    border-radius: 8px;
    border: 1px solid #ddd;
    background: #f3f3f3; cursor: pointer;
  }
  .alert {
    padding: .7rem 1rem; border-radius: 8px; margin-bottom: 1rem;
  }
  .alert-success {
    background: #e7f6ed;
    border: 1px solid #b6e1c6;
    color: #166534;
  }
  .alert-danger {
    background: #fde8e8;
    border: 1px solid #f5c2c2;
    color: #842029;
  }
  @media (max-width: 640px) {
    .grid-2 {
      grid-template-columns: 1fr;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    console.log('LOGIN SCRIPT: DOMContentLoaded');

    const form = document.getElementById('loginForm');
    console.log('LOGIN SCRIPT: form found?', !!form);

    if (!form) return;

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      console.log('LOGIN SCRIPT: submit intercepted');
      const formData = new FormData(form);
      const body = {};
      formData.forEach((v, k) => body[k] = v);
      console.log('LOGIN SCRIPT: payload', body);

      try {
        const res = await fetch('/api/sessions/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
            'X-Create-Session': '1'
          },
          credentials: 'same-origin',
          body: JSON.stringify(body)
        });

        const text = await res.text(); 
        let data;
        try { data = JSON.parse(text); } catch (e) { data = { raw: text }; }
        console.log('LOGIN SCRIPT: response body', data);

        if (!res.ok) {
          alert(data.error || data.raw || 'Credenciales inv√°lidas');
          return;
        }

        // guardar token
        const token = data.payload?.token;
        if (token) localStorage.setItem('token', token);

        // guardar usuario del payload
        if (data.payload?.user) {
          localStorage.setItem('user', JSON.stringify(data.payload.user));
        }

        // Redirigir a home
        window.location.href = '/';
      } catch (err) {
        console.error('LOGIN SCRIPT: fetch error', err);
        alert('Error de red. Intent√° nuevamente.');
      }
    });
  });
</script>

